{% extends "base.html" %}
{% load static %}

{% block title %}Lista de OcorrÃªncias{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>OcorrÃªncias Policiais Registradas</h1>
    <a href="{% url 'ocorrencia_create' %}" class="btn btn-primary shadow-sm">
        âž• Nova OcorrÃªncia
    </a>
</div>

{% if relatorio_atual %}

    {# ===================================================== #}
    {# RELATÃ“RIO EM ANDAMENTO                                #}
    {# ===================================================== #}
    {% if not relatorio_atual.finalizado %}
        <div class="alert alert-warning d-flex justify-content-between align-items-center shadow-sm border-warning mb-4">

            <div>
                <h5 class="mb-0">ðŸ“‹ RelatÃ³rio em andamento:
                    <strong>{{ relatorio_atual.nr_relatorio }}/{{ relatorio_atual.ano_criacao }}</strong>
                </h5>
                <small class="text-muted">
                    Iniciado em: {{ relatorio_atual.data_inicio|date:"d/m/Y H:i" }}
                </small>
            </div>

            <form method="post"
                  action="{% url 'finalizar_relatorio' relatorio_atual.pk %}"
                  style="margin: 0;"
                  onsubmit="return confirm('Deseja realmente finalizar este relatÃ³rio?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">
                    ðŸ›‘ Finalizar RelatÃ³rio
                </button>
            </form>

        </div>

    {# ===================================================== #}
    {# RELATÃ“RIO FINALIZADO                                  #}
    {# ===================================================== #}
    {% else %}
        <div class="alert alert-success d-flex justify-content-between align-items-center shadow-sm border-success mb-4">

            <div>
                <h5 class="mb-0">âœ… RelatÃ³rio FINALIZADO:
                    <strong>{{ relatorio_atual.nr_relatorio }}/{{ relatorio_atual.ano_criacao }}</strong>
                </h5>
                <small class="text-muted">
                    Finalizado em: {{ relatorio_atual.data_fim|date:"d/m/Y H:i" }}
                </small>
            </div>

            <div class="btn-group" role="group">

                <a href="{% url 'download_pdf_relatorio' relatorio_atual.pk %}"
                   target="_blank"
                   class="btn btn-outline-primary">
                    ðŸ“„ Exportar PDF
                </a>

                <form method="post"
                      action="{% url 'reabrir_relatorio' relatorio_atual.pk %}"
                      style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning">
                        ðŸ”“ Reabrir RelatÃ³rio
                    </button>
                </form>

            </div>

        </div>
    {% endif %}

{% endif %}

<hr>

{# ========================================================= #}
{# LISTA DE OCORRÃŠNCIAS                                      #}
{# ========================================================= #}

<div class="row">
{% for ocorrencia in ocorrencias %}
    <div class="col-12">
        <div class="card mb-3 shadow-sm border-start border-4
            {% if ocorrencia.natureza.tipo_impacto == 'P' %}
                border-success
            {% else %}
                border-danger
            {% endif %}">

            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">

                    <div>
                        <h5 class="card-title mb-1">
                            <strong>{{ ocorrencia.natureza.nome }}</strong>
                        </h5>

                        <p class="card-text mb-0">
                            <strong>Aspecto:</strong>
                            <span class="badge
                                {% if ocorrencia.natureza.tipo_impacto == 'P' %}
                                    text-bg-success
                                {% else %}
                                    text-bg-danger
                                {% endif %}">
                                {{ ocorrencia.natureza.get_tipo_impacto_display }}
                            </span>

                            <span class="mx-2 text-muted">|</span>

                            <strong>OPM:</strong> {{ ocorrencia.opm.sigla }}
                            <small class="text-muted">
                                ({{ ocorrencia.municipio }})
                            </small>

                            <span class="text-muted" style="font-size: 0.9rem;">
                                | RPI NÂº {{ relatorio_atual.nr_relatorio }}/{{ relatorio_atual.ano_criacao }}
                                - Data: {{ ocorrencia.data_hora_fato|date:"d/m/Y H:i" }}
                            </span>
                        </p>
                    </div>

                    <div class="btn-group btn-group-sm ms-3" role="group">
                        <a href="{% url 'ocorrencia_detail' ocorrencia.pk %}"
                           class="btn btn-outline-info"
                           title="Visualizar Detalhes">
                            <i class="fas fa-eye"></i>
                        </a>

                        {% if not relatorio_atual.finalizado %}
                            <a href="{% url 'ocorrencia_update' ocorrencia.pk %}"
                               class="btn btn-outline-warning"
                               title="Editar OcorrÃªncia">
                                <i class="fas fa-edit"></i>
                            </a>

                            <button type="button"
                                    class="btn btn-outline-danger btn-delete-modal"
                                    title="Excluir OcorrÃªncia"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteConfirmModal"
                                    data-delete-url="{% url 'ocorrencia_delete' ocorrencia.pk %}"
                                    data-ocorrencia-id="{{ ocorrencia.pk }}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        {% endif %}
                    </div>

                </div>
            </div>
        </div>
    </div>
{% empty %}
    <p class="text-muted">Nenhuma ocorrÃªncia cadastrada.</p>
{% endfor %}
</div>

{# ========================================================= #}
{# MODAL DE EXCLUSÃƒO                                         #}
{# ========================================================= #}

<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content border-danger">

      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">ConfirmaÃ§Ã£o de ExclusÃ£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p>Deseja excluir a ocorrÃªncia <strong id="ocorrenciaIdPlaceholder"></strong>?</p>
        <p class="text-danger">Esta aÃ§Ã£o Ã© irreversÃ­vel.</p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancelar
        </button>

        <form method="post" id="deleteForm">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">
                Excluir
            </button>
        </form>
      </div>

    </div>
  </div>
</div>

{% block extra_js %}
<script>
var deleteModal = document.getElementById('deleteConfirmModal');
if (deleteModal) {
    deleteModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var deleteUrl = button.getAttribute('data-delete-url');
        var ocorrenciaId = button.getAttribute('data-ocorrencia-id');

        document.getElementById('deleteForm').action = deleteUrl;
        document.getElementById('ocorrenciaIdPlaceholder').textContent = '#' + ocorrenciaId;
    });
}
</script>
{% endblock extra_js %}

{% endblock content %}
