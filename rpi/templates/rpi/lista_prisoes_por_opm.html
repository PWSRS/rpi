{% extends "base.html" %}
{% load static %}

{% block title %}Prisões por OPM{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-boxes me-2"></i>Prisões por OPM</h1>
    <a href="javascript:history.back()" class="btn btn-outline-secondary shadow-sm">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>
</div>

<!-- Filtro por período -->
<div class="card shadow-sm mb-4 border-primary">
    <div class="card-header bg-primary text-white py-2">
        <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtrar por Período</h6>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label small fw-bold">Data Inicial</label>
                <input type="date" name="data_inicio" class="form-control"
                       value="{{ request.GET.data_inicio }}">
            </div>
            <div class="col-md-4">
                <label class="form-label small fw-bold">Data Final</label>
                <input type="date" name="data_fim" class="form-control"
                       value="{{ request.GET.data_fim }}">
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary w-100">
                    <i class="fas fa-search me-1"></i> Filtrar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Lista de envolvidos por OPM -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0">
            Lista de Indivíduos (Presos, Suspeitos, Acusados, Menores Infratores)
        </h5>
    </div>

    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light text-center">
                    <tr>
                        <th>Data</th>
                        <th>OPM</th>
                        <th>Nome</th>
                        <th>Idade</th>
                        <th>Doc.</th>
                        <th>Nr</th>
                        <th>Tipo</th>
                        <th>Antec.</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>

                {% for opm, dados in envolvidos_por_opm.items %}

                    <!-- Cabeçalho da OPM -->
                    <tr class="table-secondary">
                        <td colspan="9" class="fw-bold text-start ps-3">
                            <i class="fas fa-building me-2"></i>{{ opm|default:"OPM não informada" }}
                        </td>
                    </tr>
                    
                    <!-- Resumo da OPM -->
                    <tr class="table-light">
                        <td colspan="9" class="ps-4 small">
                            <strong>Resumo:</strong>
                            Presos: {{ dados.resumo.P }}
                            &nbsp;|&nbsp; Suspeitos: {{ dados.resumo.S }}
                            &nbsp;|&nbsp; Acusados: {{ dados.resumo.A }}
                            &nbsp;|&nbsp; Menores: {{ dados.resumo.M }}
                            &nbsp;|&nbsp;
                            <strong>Total: {{ dados.resumo.total }}</strong>
                        </td>
                    </tr>

                    <!-- Lista de indivíduos -->
                    {% for item in dados.lista %}
                    <tr>
                        <td class="text-center">
                            {{ item.ocorrencia.data_hora_fato|date:"d/m/Y" }}
                        </td>
                        <td class="text-center">{{ opm }}</td>
                        <td><strong>{{ item.nome }}</strong></td>
                        <td class="text-center">{{ item.idade|default:"-" }}</td>
                        <td class="text-center">{{ item.get_tipo_documento_display|default:"-" }}</td>
                        <td class="text-center">{{ item.nr_documento|default:"-" }}</td>
                        <td class="text-center">
                            <span class="badge
                                {% if item.tipo_participante == 'P' %} bg-dark
                                {% elif item.tipo_participante == 'S' %} bg-warning text-dark
                                {% elif item.tipo_participante == 'A' %} bg-danger
                                {% elif item.tipo_participante == 'M' %} bg-info
                                {% else %} bg-secondary {% endif %}">
                                {{ item.get_tipo_participante_display }}
                            </span>
                        </td>
                        <td class="text-center">{{ item.get_antecedentes_display }}</td>
                        <td class="text-center">
                            <a href="{% url 'ocorrencia_detail' item.ocorrencia.id %}"
                               class="btn btn-sm btn-outline-info">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}

                {% empty %}
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            Nenhum registro encontrado.
                        </td>
                    </tr>
                {% endfor %}

                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}
