{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Relatório {{ relatorio.nr_relatorio }}/{{ relatorio.ano_criacao }}</title>
    <link rel="stylesheet" href="{{ css_uri }}">
</head>
<style>
    /* Configuração Geral (vale para todas as páginas) */
@page {
    size: A4;
    margin: 2cm;

     @top-left {
        content: ' Continuação do RPI Nº {{relatorio.nr_relatorio}}/ARI SUL - SISTEMA DE INTELIGÊNCIA - CRPM SUL - BRIGADA MILITAR';
        font-family: Arial, sans-serif;
        font-size: 9pt;
        color: #999;
        text-decoration: underline;

    }

    @bottom-right {
        content: 'Página ' counter(page) ' de ' counter(pages);
        font-family: Arial, sans-serif;
        font-size: 9pt;
        color: #666;
    }

}

/* Configuração Específica para a Primeira Página (Capa) */
/* Isso "limpa" o conteúdo definido acima apenas na pág 1 */
@page :first {
    @top-left {
        content: '';
    }
    @bottom-right {
        content: '';
    }
}

</style>
<body>

<header>
    <img src="{{ logo_uri }}" alt="Logo da Brigada Militar" class="logo">
    <p><strong>ESTADO DO RIO GRANDE DO SUL</strong></p>
    <p><strong>SECRETARIA DA SEGURANÇA PÚBLICA</strong></p>
    <p><strong>BRIGADA MILITAR</strong></p>
    <p><strong>SISTEMA DE INTELIGÊNCIA</strong></p>
    <h1>
        RELATÓRIO PERIÓDICO DE INTELIGÊNCIA Nº
        {{ relatorio.nr_relatorio }}/{{ relatorio.ano_criacao }}/ARI SUL -
        {{ relatorio.data_inicio|date:"d/m/Y" }}
    </h1>
</header>

<!-- ================= SUMÁRIO ================= -->

<h2 id="inicio_sumario">SUMÁRIO</h2>
<p class="periodo">
    PERÍODO: DE {{ relatorio.data_inicio|date:"d" }}0700{{ relatorio.data_inicio|date:"MY"|upper }} 
    A {{ relatorio.data_fim|date:"d" }}0700{{ relatorio.data_fim|date:"MY"|upper }}
</p>

{% for item in ocorrencias %}
<p>
    <a href="#ocorrencia_{{ forloop.counter }}" class="sumario-link">
        {{ forloop.counter }}.
        {{ item.ocorrencia.natureza.nome|upper }} –
        {{ item.ocorrencia.municipio|upper }}
        ({{ item.sigla_opm_limpa|upper }})
    </a>
</p>
{% endfor %}

{% if ocorrencias_cvli %}
<p>
    <a href="#secao_cvli" class="sumario-link">
        {{ numero_cvli }}. CRIMES VIOLENTOS LETAIS INTENCIONAIS (CVLI)
    </a>
</p>

<p style="font-size: 0.8em; margin-left: 15px;">
    Total de CVLI nas últimas 24h: {{ total_cvli }} ({{ cvli_resumo_opm }})
</p>
{% endif %}

<!--<div style="page-break-before: always;"></div>-->
<div class="page-break"></div>

<!-- ================= OCORRÊNCIAS NORMAIS ================= -->

{% for item in ocorrencias %}
{% with ocorrencia=item.ocorrencia %}
<div class="ocorrencia" id="ocorrencia_{{ forloop.counter }}"
     style="page-break-inside: avoid; margin-bottom: 25px;">

<p class="titulo">
    {{ forloop.counter }}.
    {{ ocorrencia.natureza.nome|upper }} –
    {{ ocorrencia.municipio|upper }}
    ({{ item.sigla_opm_limpa|upper }})
</p>

<p style="text-align: justify;">
    <strong>Em {{ ocorrencia.data_hora_bruta }},</strong>
    na {{ ocorrencia.rua }}, nº {{ ocorrencia.numero }},
    bairro {{ ocorrencia.bairro }},
    na cidade de {{ ocorrencia.municipio }},
    {{ ocorrencia.relato_historico }}
    <a href="#inicio_sumario" class="voltar-link">(VOLTAR)</a>
</p>

{% if item.envolvidos_com_foto %}
<div class="detalhes-tecnicos" style="margin-top: 10px; margin-left: 20px;">
    <strong>Participante(s):</strong>
    
    <ul style="list-style: none; padding: 0; margin-top: 5px; margin-bottom: 10px;">
        {% for env_data in item.envolvidos_com_foto %}
        {% with env=env_data.obj %}
            <li style="margin-bottom: 4px; text-align: justify;">
                * {{ env.nome|upper }}, 
                {{ env.idade|default:"??" }} anos, 
                {{ env.get_tipo_documento_display|default:"-" }} {{ env.nr_documento|default:"-" }} - 
                ({{ env.get_tipo_participante_display }}). 
                Antecedentes: {% if env.antecedentes == 'S' %}SIM{% else %}NÃO{% endif %}.
            </li>
        {% endwith %}
        {% endfor %}
    </ul>

    <div class="galeria-participantes">
        {% for env_data in item.envolvidos_com_foto %}
        {% with env=env_data.obj %}
            {% if env_data.foto_uri %}
            <div class="bloco-foto-participante">
                <img src="{{ env_data.foto_uri }}" class="foto-perfil">
                <div class="legenda-nome">
                    {# split.0 pega o primeiro nome; upper deixa em maiúsculo #}
                    {{ env.nome.split.0|upper }}
                </div>
            </div>
            {% endif %}
        {% endwith %}
        {% endfor %}
    </div>
</div>
{% endif %}

{% if ocorrencia.apreensoes.all %}
<div class="detalhes-tecnicos" style="margin-top: 5px; margin-left: 20px; font-size: 0.9em;">
    <strong>Material Apreendido:</strong>
    <ul style="list-style: none; padding: 0;">
        {% for mat in ocorrencia.apreensoes.all %}
        <li>
            * {% if mat.unidade_medida == 'R$' or mat.unidade_medida == 'US$' or mat.unidade_medida == '€' %}
                {# Moedas: Exibe o símbolo ANTES da quantidade #}
                {{ mat.unidade_medida }} {{ mat.quantidade }}
            {% else %}
                {# Outras medidas: Exibe a quantidade ANTES da unidade (kg, un, g) #}
                {{ mat.quantidade }} {{ mat.unidade_medida }}
            {% endif %}
            
            {{ mat.material_tipo }}{% if mat.descricao_adicional %}, {{ mat.descricao_adicional }}{% endif %}.
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="galeria-participantes">
    {% for imagem in item.imagens %}
    <div class="bloco-evidencia">
        <img src="{{ imagem.uri }}" class="img-padronizada">
        <div class="legenda-nome">{{ imagem.legenda|default:"EVIDÊNCIA"|upper }}</div>
    </div>
    {% endfor %}
</div>

</div>
{% endwith %}
{% endfor %}

<!-- ================= SEÇÃO CVLI ================= -->

{% if ocorrencias_cvli %}
<!--<div style="page-break-before: always;"></div>-->
<div class="bloco-cvli">

<div id="secao_cvli">

<h2 class="titulo-secao-cvli">
    {{ numero_cvli }}. CRIMES VIOLENTOS LETAIS INTENCIONAIS (CVLI)
</h2>

<table style="width:100%; border-collapse: collapse; font-size: 0.9em;">
    <thead>
        <tr>
            <th style="border:1px solid #000; padding:5px;">MUNICÍPIO</th>
            <th style="border:1px solid #000; padding:5px;">OPM</th>
            <th style="border:1px solid #000; padding:5px;">Nº VÍTIMAS</th>
            <th style="border:1px solid #000; padding:5px;">INSTRUMENTO</th>
        </tr>
    </thead>
    <tbody>
        {% for linha in tabela_cvli %}
        <tr>
            <td style="border:1px solid #000; padding:5px;">
                {{ linha.municipio|upper }}
            </td>
            <td style="border:1px solid #000; padding:5px;">
                {{ linha.opm|upper }}
            </td>
            <td style="border:1px solid #000; padding:5px; text-align:center;">
                {{ linha.vitimas }}
            </td>
            <td style="border:1px solid #000; padding:5px;">
                {{ linha.instrumento|upper }}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h3>
    {{ numero_cvli }}.1 HISTÓRICO DOS CVLI
</h3>

{% for item in ocorrencias_cvli %}
{% with ocorrencia=item.ocorrencia %}
<p class="titulo">
    {{ item.letra }})
    {{ ocorrencia.natureza.nome|upper }} –
    {{ ocorrencia.municipio|upper }}
    ({{ item.sigla_opm_limpa|upper }})
</p>


<p style="text-align: justify;">
    <strong>Em {{ ocorrencia.data_hora_bruta }},</strong>
    na {{ ocorrencia.rua }}, nº {{ ocorrencia.numero }},
    bairro {{ ocorrencia.bairro }},
    {{ ocorrencia.relato_historico }}
    <a href="#inicio_sumario" class="voltar-link">(VOLTAR)</a>
</p>

{% if item.envolvidos_com_foto %}
    <div class="detalhes-tecnicos" style="margin-top: 10px; margin-left: 20px;">
        <strong>Participante(s):</strong>
        
        <ul style="list-style: none; padding: 0; margin-top: 5px;">
            {% for env_data in item.envolvidos_com_foto %}
            {% with env=env_data.obj %}
                <li style="margin-bottom: 3px;">
                    * {{ env.nome|upper }}, {{ env.idade|default:"??" }} anos, 
                    {{ env.get_tipo_documento_display|default:"-" }} {{ env.nr_documento|default:"-" }} - 
                    ({{ env.get_tipo_participante_display }}). 
                    Antecedentes: {% if env.antecedentes == 'S' %}SIM{% else %}NÃO{% endif %}.
                </li>
            {% endwith %}
            {% endfor %}
        </ul>

        <div class="galeria-participantes">
            {% for env_data in item.envolvidos_com_foto %}
            {% with env=env_data.obj %}
                {% if env_data.foto_uri %}
                <div class="bloco-foto-participante">
                    <img src="{{ env_data.foto_uri }}" class="foto-perfil">
                    <div class="legenda-nome">
                        {# Pegamos apenas o primeiro nome para a legenda #}
                        {{ env.nome.split.0|upper }}
                    </div>
                </div>
                {% endif %}
            {% endwith %}
            {% endfor %}
        </div>
    </div>
{% endif %}
    {% if ocorrencia.apreensoes.all %}
    <div class="detalhes-tecnicos"
         style="margin-top: 5px; margin-left: 20px; font-size: 0.9em;">
        <strong>Material Apreendido:</strong>
        <ul style="list-style: none; padding: 0;">
            {% for mat in ocorrencia.apreensoes.all %}
            <li>
                * {% if mat.unidade_medida == 'R$' or mat.unidade_medida == 'US$' or mat.unidade_medida == '€' %}
                    {# Moedas: Exibe o símbolo ANTES da quantidade #}
                    {{ mat.unidade_medida }} {{ mat.quantidade }}
                {% else %}
                    {# Outras medidas: Exibe a quantidade ANTES da unidade (kg, un, g) #}
                    {{ mat.quantidade }} {{ mat.unidade_medida }}
                {% endif %}
                
                {{ mat.material_tipo }}{% if mat.descricao_adicional %}, {{ mat.descricao_adicional }}{% endif %}.
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    <div class="galeria-participantes">
        {% for imagem in item.imagens %}
        <div class="bloco-evidencia">
            <img src="{{ imagem.uri }}" class="img-padronizada">
            <div class="legenda-nome">{{ imagem.legenda|default:"EVIDÊNCIA"|upper }}</div>
        </div>
        {% endfor %}
    </div>
{% endwith %}
{% endfor %}

</div>
{% endif %}

</body>
</html>
